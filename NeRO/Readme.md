# 神经 BRDF (NeRO)

## 背景

1. 多视角重建对于高光或者镜面，物体颜色会随观测方向变化，违反视差一致性

2. 神经隐式表示与体渲染 + 考虑物理光照

3. 微表面 BRDF 模型 (Cook-Torrance)：将表面反射分为漫反射和，镜面反射部分

   - 漫反射部分：朗伯系数
   - 镜面反射部分：基于微表面理论，通过法线分布函数（GGX分布），Fresnel 项（参数是出射/入射角，金属度，输出反射率）和几何遮挡项

4. Kajiya 渲染方程：描述点的出射辐射度对于入射半球辐射度与表面 BRDF 以及余弦因子的积分结果，采用分裂求和近似（Split-sum）求解，光照积分拆成环境光照与 BRDF（NeRO 第一部分方法）。第二部分使用蒙特卡洛采样，通过重要性采样分别对漫反射余弦权重半球和 GGX 镜面半球采样，准确估计颜色

5. 神经渲染技术：

   - NeRF（Neural Radiance Fields）对每个点学习体密度和辐射度
   - NeuS（Neural Implicit Surfaces） 曲面表示为神经SDF零水平集，无偏体渲染模型直接学习 SDF（距离符号函数）
   - Ref-NeRF 在 NeRF 基础上将出射光分为漫反射和镜面反射分量，并通过集成方向编码（IDE）对视角编码进行预积分

## 网络架构

![Architecture of networks in Stage I](./Network1.png "Architecture of networks in Stage I")

### 神经 SDF 网络

**p(x,y,z) 空间坐标**经位置编码 PE 输入，输出该点到物体表面的**有符号距离**（零水平集即物体表面），同时也可导出法向量辅助渲染

### 材质网络

以**表面点或法向量**为输入，预测**材质参数**，金属度 m，粗糙度 r，反照率 a，这些参数控制 Cook-Torrance BRDF 模型行为

### 光照网络

1. 包含两个主要MLP：直接和间接光网络，以及一个额外的遮挡网络，直接光网络接受**光照方向编码**，预测来自无穷远光源的直接辐射强度，间接光网络接受**空间位置和方向编码**，预测由物体表面反射产生的间接光照，遮挡网络对每一个采样射线预测一个 [0,1] 间的**概率**，判断该方向上光线是否被物体自身遮挡

2. 输入 v **视角方向**，加入**法向量**经过反射计算**出射光线方向** t。DE 是方向编码，将单位方向编码映射为更高维的特征向量，让 MLP 能够更有效表达。IDE 则是对方向分布做积分后展开（DE 仅对方向直接余弦展开），相比低频或者直接光，可表示高频镜面反射或者模糊高光。IDE 由Ref-NeRF 提出，对每一个采样方向的预集成编码来平滑和加速积分计算。

3. Opaque Density 是不透明度，输入 SDF，输出 w **体渲染权重**

4. Shading 积分计算物体表面对入射光的反射颜色，输出**颜色** c，这里用 Split-sum 和 IDE 近似计算

### 摄影师表面模型

解决现实拍摄中摄影师自身出现在反射中的问题，构建了一个 2D NeRF 模型，通过 MLP 计算反照率和颜色，判断是否击中摄影者，并将摄影者反射视为光照的一部分纳入计算

## 光照表示和方向编码

### 光照分解

分解为直接光和间接光，已经说明在光照网络中

### 方向编码

直接光网络采用球面调和基底函数 SH 将方向映射到高阶，间接光网络采用传统位置和方向编码。第一阶段，Split-sum 近似对 BRDF 积分采用 IDE 处理，捕获高频镜面反射。第二阶段，几何已经固定，采用蒙特卡洛采样，精确计算

### 球面交点编码 SIE

直接光仅靠方向无法准确定位强光源（尤其近处），在第二阶段，对直接光 MLP 额外输入了发射点沿方向射线与包围球相交的点坐标

## 训练损失

### 渲染损失

采用 Charbonier 损失度量体渲染合成的像素颜色与输入图像颜色的差异，主要训练损失

### Eikonal 损失

目的为规范神经 SDF 网络，强制梯度范数趋向 1 以保证场域近似为距离函数

### 遮挡一致性损失

对每个样本点以其反射方向进行射线跟踪得到真实遮挡概率，强制 MLP 预测结果与之匹配（第二阶段，不用网络，用物理计算

### 表面稳定性正则

### 阶段 II 正则项

1. 材质平滑正则，平滑粗糙度，金属度，反照率

2. 漫反射光白化正则，强制漫反射光色接近白光（最小化漫反射光 RGB 通道与平均值差异）

## 数据集构建

1. Glossy-Blender 合成光滑物体数据集

2. Glossy-Real 真实世界的光滑物体数据集

## 验证与评测指标

1. 几何评价指标：采用 Chamfer 距离衡量重建表面与真实表面点云匹配度

2. 重光照评价指标：估计的材质与Blender生成的图像对比

3. 消融实验

## 理解与问题

1. NeRO 是**多视角重建**不是单目估计，多张照片输入，以这些视角的相机位姿联合优化隐式 SDF，材质和光照。镜面高光会破坏光度一致性，所以 NeRO 分两阶段并使用 BRDF 和 光照建模

2. 优化在于对于**无目标掩码**，**未知环境照明**情景，采用显式物理渲染模型，环境光近似技术和两阶段优化策略

3. 体渲染采样，SDF 平滑化以及损失中的平滑正则，使得隐式 SDF 在细薄和高曲率结构（尤其反光强烈时）中出现模糊和拓扑错误，损失了物体**表面细节**，没有细节感觉多视角的一部分优势就没有了

4. 对**相机质量敏感**，尤其在反射强时，高光导致欺骗匹配（曝光问题）

5. **近场光源**问题，SIE 处理不足

6. **材质/光照分离模糊**，RGB 图像对反照率和照明强度有尺度模糊，还有如何辨别漫反射和间接光，尤其是反射表面（如何分离金属度，粗糙度，光照）

7. **透明、半透明、发光、参与媒质（雾和烟）场景**，体散射场景不适用不透明微表面 BRDF

## 日志

### 2025.10.11

- 今天日志
- 相机质量问题是否可以用图像处理技术，例如人工调整颜色，处理曝光和对比度等，尤其对于高感和高位深相机
- 材质问题是否可以用语意分割，分开不同场景的1表面，例如透明、半透明，对于参与介质和发光，再考虑
